#!/bin/bash
# Safe wrapper for omarchy-update that backs up configs and handles conflicts better

set -e

OMARCHY_PATH="${OMARCHY_PATH:-$HOME/.local/share/omarchy}"
BACKUP_DIR="$HOME/.local/share/omarchy-backups/$(date +%Y%m%d_%H%M%S)"
CONFIG_FILES=(
    "default/hypr/apps/pip.conf"
    "default/hypr/apps.conf"
    "default/hypr/bindings.conf"
    "default/hypr/autostart.conf"
    "default/hypr/envs.conf"
    "default/hypr/input.conf"
    "default/hypr/looknfeel.conf"
)

echo "üîí Creating backup before omarchy update..."
mkdir -p "$BACKUP_DIR"

# Backup any modified config files
cd "$OMARCHY_PATH"
for file in "${CONFIG_FILES[@]}"; do
    if [ -f "$file" ]; then
        mkdir -p "$BACKUP_DIR/$(dirname "$file")"
        cp "$file" "$BACKUP_DIR/$file"
        echo "  ‚úì Backed up: $file"
    fi
done

# Check for uncommitted changes
if ! git diff --quiet || ! git diff --cached --quiet; then
    echo "‚ö†Ô∏è  Warning: You have uncommitted changes in omarchy directory"
    echo "   These will be stashed automatically by omarchy-update"
    read -p "   Continue? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "‚ùå Update cancelled"
        exit 1
    fi
fi

# Configure git for better merge handling
cd "$OMARCHY_PATH"
git config merge.ours.driver true 2>/dev/null || true

# Run the actual update
echo ""
echo "üîÑ Running omarchy-update..."
if omarchy-update; then
    echo ""
    echo "‚úÖ Update completed successfully!"
    echo "üì¶ Backup saved to: $BACKUP_DIR"
    
    # Check if there are conflicts
    if git diff --check 2>&1 | grep -q "conflict"; then
        echo ""
        echo "‚ö†Ô∏è  Conflicts detected! Check the output above."
        echo "   Your backup is at: $BACKUP_DIR"
        echo "   To restore: cp $BACKUP_DIR/* $OMARCHY_PATH/"
    fi
else
    echo ""
    echo "‚ùå Update failed!"
    echo "üì¶ Your backup is at: $BACKUP_DIR"
    echo "   To restore: cp $BACKUP_DIR/* $OMARCHY_PATH/"
    exit 1
fi

